<!DOCTYPE HTML>
<html>

<head>
    <!-- when using the mode "code", it's important to specify charset utf-8 -->
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width">
    <link href="/style.css" rel="stylesheet" type="text/css">

    <title>Json view</title>

</head>

<body>

    <a href="/paste/">paste</a>

    <ul id="list"></ul>

    <div id="content"></div>


    <script>

        var fileParam = window.location.pathname.split('/')[2]

        var contentEl = document.getElementById('content');

        //console.log('fileParam', fileParam);

        if(typeof fileParam === 'undefined' || fileParam === ''){
            getFilesList();
        }

        if (typeof fileParam !== 'undefined' && fileParam !== '') {
            getFile(fileParam);
        }

        var listEl = document.getElementById('list');

        function getFilesList(){
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/files');
            xhr.onload = function () {
                if (xhr.status === 200) {

                    var files = JSON.parse(xhr.responseText);

                    var listTemplate = '';
                    for (var file of files) {
                        var fileName = file.replace('.js', '').replace('file-', '')
                        listTemplate += '<li><a href="" class="file" data-file="' + fileName + '">' + fileName + '</a> - <a href="/view/' + fileName + '">url</a></li>';
                    }

                    listEl.innerHTML = listTemplate

                    var filesEls = Array.prototype.slice.call(document.getElementsByClassName('file'));

                    for (var fileEl of filesEls) {
                        fileEl.addEventListener("click", function (e) {
                            e.preventDefault();

                            getFile(e.target.dataset.file);
                        });
                    }

                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();
        }

        function getFile(fileName){

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/files/' + fileName);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var file = JSON.parse(xhr.responseText);

                    contentEl.innerHTML = renderFile(file);

                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send();

        }

        function renderFile(fileEntries){

            console.log('fileEntries', fileEntries, 'typeof', typeof fileEntries);

            var fileTemplate = '';

            if (typeof fileEntries !== 'object') {
                fileTemplate += '<p>'
                fileTemplate += fileEntries
                fileTemplate += '</p>'
            }

            if(typeof fileEntries === 'object'){
                Object.keys(fileEntries).forEach(function (key) {

                    console.log('object entry', key, fileEntries[key], typeof (fileEntries[key]));

                    // string - number
                    if (typeof (fileEntries[key]) == 'string' || typeof (fileEntries[key]) == 'number' || typeof (fileEntries[key]) == 'boolean') {

                        fileTemplate += '<h3>'
                        fileTemplate += key
                        fileTemplate += '</h3>'

                        fileTemplate += '<p>'
                        fileTemplate += fileEntries[key]
                        fileTemplate += '</p>'
                    }

                    if (typeof (fileEntries[key]) == 'object') {

                        if (fileEntries[key] === null) {
                            console.log('null');

                            fileTemplate += '<h3>'
                            fileTemplate += key
                            fileTemplate += '</h3>'

                            fileTemplate += '<p>'
                            fileTemplate += 'no entry'
                            fileTemplate += '</p>'
                        }

                        if (fileEntries[key] !== null) {

                            fileTemplate += '<h3>'
                            fileTemplate += key
                            fileTemplate += '</h3>'
                            fileTemplate += '<ul>'

                            if (fileEntries[key] instanceof Array) {
                                console.log('is an array, iterate');

                                for (var fileDubEntry of fileEntries[key]) {
                                    fileTemplate += '<li>'
                                    fileTemplate += renderFile(fileDubEntry);
                                    fileTemplate += '</li>'
                                }

                            } else {
                                fileTemplate += renderFile(fileEntries[key]);
                            }

                            fileTemplate += '</ul>'
                        }


                    }
                });
            }




            return fileTemplate;
        }



    </script>
</body>

</html>